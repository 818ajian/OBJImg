<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8"/>
	<title>OBJImg</title>
	<style type="text/css">

		* {
			margin: 0;
			padding: 0;
			border: 0;
		}

		html {
			overflow: hidden;
			background-color: #222222;
		}

		canvas:first-child {
			width: 100%;
			height: 100%;
		}

		canvas:last-child {
			position: absolute;
			top: 0;
			left: 0;
		}

	</style>
	<script type="text/javascript" src="three-js/build/three.js"></script>
	<script type="text/javascript" src="three-js/src/loaders/OBJLoader.js"></script>
	<script type="text/javascript" src="objimg.js"></script>
	<script type="text/javascript">

		window.onload = function(){

			var width = window.innerWidth;
			var height = window.innerHeight;
			var aspect = width / height;

			var renderer = new THREE.WebGLRenderer({
				precision: "highp",
				premultipliedAlpha: true,
				alpha: true,
				antialias: true
			});

			renderer.setSize(width, height);

			document.body.appendChild(renderer.domElement);

			var camera = new THREE.PerspectiveCamera(75, aspect, 0.1, 10000);
			camera.position.set(0, 0, 200);

			window.addEventListener("resize", function( event ){

				width = window.innerWidth;
				height = window.innerHeight;

				renderer.setSize(width, height);

				camera.aspect = width / height;
				camera.updateProjectionMatrix();

			}, false);

			var scene = new THREE.Scene();

			var ambient = new THREE.AmbientLight(0x000000);
			scene.add(ambient);

			var image = new Image();

			var generatedObject = new Object();

			var imageFile = "cube";
			var objFile = "cube";

			var xhr = new XMLHttpRequest();
			xhr.open("GET", "models/" + objFile + ".obj", false);
			xhr.send(null);

			OBJImg.generateImg(xhr.responseText);

			image.onload = function( event ){

				generatedObject.datas = new OBJImg(this);

				console.log(generatedObject.datas);

				generatedObject.geometry = new THREE.Geometry();

				for( var vertex = 0, length = generatedObject.datas.vertices.length; vertex < length; vertex++ ){

					generatedObject.geometry.vertices.push(new THREE.Vector3(generatedObject.datas.vertices[vertex].x, generatedObject.datas.vertices[vertex].y, generatedObject.datas.vertices[vertex].z));
				
				};

				for( var face = 0, length = generatedObject.datas.faces.length; face < length; face++ ){

					var vertexA = /*generatedObject.geometry.vertices[*/generatedObject.datas.faces[face].vertices.a/*]*/;
					var vertexB = /*generatedObject.geometry.vertices[*/generatedObject.datas.faces[face].vertices.b/*]*/;
					var vertexC = /*generatedObject.geometry.vertices[*/generatedObject.datas.faces[face].vertices.c/*]*/;

					console.log(vertexA, vertexB, vertexC)

					generatedObject.geometry.faces.push(new THREE.Face3(vertexA, vertexB, vertexC));

				};

				console.log( generatedObject )

				generatedObject.geometry.computeBoundingBox();

				var size = Math.abs(generatedObject.geometry.boundingBox.min.x - generatedObject.geometry.boundingBox.max.x);

				console.log(size);

				camera.position.set(0, 0, size * 2);

				generatedObject.material = new THREE.PointCloudMaterial({
					color: 0xFF0000,
					size: 2,
					sizeAttenuation: false
				});

				generatedObject.mesh = new THREE.PointCloud(generatedObject.geometry, generatedObject.material);

				scene.add(generatedObject.mesh);

				generatedObject.meshBis = new THREE.Mesh(generatedObject.geometry.clone(), new THREE.MeshBasicMaterial({
					color: 0xFF0000
				}));

				// Source

				var loader = new THREE.OBJLoader();

				loader.load("models/" + imageFile + ".obj", function( object ){

					generatedObject.source = object;
					generatedObject.source.children[0].material.wireframe = true;

					scene.add(generatedObject.source);

				});

			};

			image.src = "models/" + imageFile + ".png";

			function render( now ){

				window.requestAnimationFrame(render);

				if( generatedObject.mesh ){

					// generatedObject.mesh.rotateOnAxis(new THREE.Vector3(0, 0.2, 0), Math.PI / 180);
					// generatedObject.source.rotateOnAxis(new THREE.Vector3(0, 0.2, 0), Math.PI / 180);

				};

				renderer.render(scene, camera);

			};

			window.requestAnimationFrame(render);

		};

	</script>
</head>
<body></body>
</html>